% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/indexCEI.R
\name{CEI}
\alias{CEI}
\title{Condition Excess Index}
\usage{
CEI(
  df,
  id = "id",
  x_col,
  start_date,
  season_start = "07-01",
  season_end = "06-30",
  lower,
  upper = Inf,
  inc_lower = TRUE,
  inc_upper = TRUE,
  min_duration = 1L,
  na_action = c("false", "skip_days")[1]
)
}
\arguments{
\item{df}{Tibble/data.frame with one row per day and per \code{id}. All \code{id}s must
have the same number of rows (daily-regular series).}

\item{id}{Character, name of the \code{id} column (default \code{"id"}).}

\item{x_col}{Character, name of the \strong{single} numeric variable to analyse.}

\item{start_date}{Date of the first row for each \code{id} (used to build the
calendar and season mapping).}

\item{season_start, season_end}{Character \code{"mm-dd"} giving the season window.
The window may \strong{cross years} (e.g., \code{"07-01"} -> \code{"06-30"}).}

\item{lower, upper}{Numeric bounds defining the valid interval for \code{x}.
\describe{
\item{\code{lower}}{\strong{Required} and must be finite. The excess is defined as
\code{x - lower} (capped at 0 below \code{lower}).}
\item{\code{upper}}{Optional (default \code{Inf}). Use to restrict the valid range
above; values beyond \code{upper} contribute 0 and break runs depending on
\code{na_action}.}
}}

\item{inc_lower, inc_upper}{Logical flags controlling interval inclusivity
(both default \code{TRUE}):
\describe{
\item{\code{inc_lower = TRUE}}{\code{x >= lower} qualifies; \code{FALSE} means
\code{x > lower}.}
\item{\code{inc_upper = TRUE}}{\code{x <= upper} qualifies; \code{FALSE} means
\code{x < upper}.}
}}

\item{min_duration}{Integer >= 1. Minimum number of \strong{consecutive qualifying
days} required before the run contributes to the cumulative:
\itemize{
\item If \code{min_duration = 1}, every qualifying day contributes its excess
immediately.
\item If \code{min_duration = m > 1}, the first day that brings the run length
to \code{m} contributes its own excess \strong{plus} a one-off \strong{bonus} equal
to the sum of the previous \code{m - 1} days' excesses in that run (bias
correction). Subsequent days in the run contribute their own excess
normally.
}}

\item{na_action}{Character controlling how missing values in \code{x} are handled:
\describe{
\item{\code{"false"}}{Treat \code{NA} as out-of-range (i.e., \code{cond = FALSE}). This
\strong{breaks runs} and contributes 0 excess on those days.}
\item{\code{"skip_days"}}{Drop days with \code{NA} in \code{x} \strong{before} evaluating
conditions. Consecutivity is then defined over the remaining observed
days.}
}}
}
\value{
A tibble with daily rows and columns:
\itemize{
\item \code{id} - identifier (station/cell).
\item \code{day_idx} - 1..n index within the full time series per \code{id}.
\item \code{season_id}, \code{season_label} - season identifiers.
\item \code{cond} - logical; \code{TRUE} when \code{x} lies within the specified
interval.
\item \code{valid} - logical; \code{TRUE} once the current TRUE-run reaches
\code{min_duration}.
\item \code{excess} - numeric; \code{pmax(x - lower, 0)} on qualifying days,
else 0.
\item \code{cum_excess} - season-wise cumulative of excess with per-run
correction.
}
}
\description{
Daily accumulator of \emph{excess over lower} for a single variable.
For each \code{id} and season, computes a \emph{daily} cumulative series \code{cum_excess}
from a \strong{single climatic variable} \code{x}. A day contributes the value
\code{excess = (x - lower)} \strong{only if} \code{x} lies within the interval
\verb{[lower, upper]} (with configurable inclusivity). The contribution is further
gated by a \strong{minimum run-length} requirement \code{min_duration}: a day only
counts if it belongs to a TRUE-run whose length has reached at least
\code{min_duration}.
}
\details{
\strong{Units.} \code{excess} and \code{cum_excess} are in the same units as \code{x}.
\strong{Capping.} By default, \code{excess} is not capped at \code{(upper - lower)}; if you
want to cap it, post-process with \code{excess <- pmin(excess, upper - lower)}
before accumulation.
\strong{Semantics.} The online bias-corrected cumulative equals the retrospective
(full-season) total for runs that have already completed, while remaining
conservative for runs that are still in progress at the season boundary.
}
\examples{
set.seed(42)
df <- tibble::tibble(
  id = rep(c("A", "B"), each = 10),
  date = as.Date("2000-01-01") + rep(0:9, times = 2),
  temp = runif(20, 20, 40)
)

# Accumulate excess temperature above 25 degC whenever 25 <= temp (no upper cap),
# with runs of at least 3 consecutive qualifying days.
CEI(
  df,
  id = "id", x_col = "temp",
  start_date = min(df$date),
  lower = 25, upper = Inf,
  min_duration = 3
)

# Same but only count when 25 <= temp <= 35, exclusive upper bound
CEI(
  df,
  id = "id", x_col = "temp",
  start_date = min(df$date),
  lower = 25, upper = 35,
  inc_upper = FALSE,
  min_duration = 2
)

}
\author{
Sara Herrera
}
